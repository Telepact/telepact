name: CI

on:
    workflow_dispatch:

jobs:
    build-uapi-ts:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: "16"

            - name: Install dependencies
              run: |
                  cd lib/ts
                  npm install

            - name: Build ts
              run: |
                  cd lib/ts
                  npm run build

    build-uapi-java:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Java
              uses: actions/setup-java@v2
              with:
                  java-version: "21"
                  distribution: "corretto"

            - name: Install dependencies and build
              run: |
                  cd lib/java
                  mvn install

    build-uapi-py:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Python
              uses: actions/setup-python@v2
              with:
                  python-version: "3.11"

            - name: Install pipx
              run: |
                  python3 -m pip install --user pipx
                  python3 -m pipx ensurepath

            - name: Install Poetry
              run: |
                  pipx install poetry

            - name: Install dependencies
              run: |
                  cd lib/py
                  poetry install

            - name: Build py
              run: |
                  cd lib/py
                  poetry build

    run-tests:
        runs-on: ubuntu-latest
        needs: [build-uapi-ts, build-uapi-java, build-uapi-py]
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Python
              uses: actions/setup-python@v2
              with:
                  python-version: "3.11"

            - name: Install pipx
              run: |
                  python3 -m pip install --user pipx
                  python3 -m pipx ensurepath

            - name: Install Poetry
              run: |
                  pipx install poetry

            - name: Download ts build artifacts
              uses: actions/download-artifact@v2
              with:
                  name: build-uapi-ts
                  path: lib/ts/dist

            - name: Download java build artifacts
              uses: actions/download-artifact@v2
              with:
                  name: build-uapi-java
                  path: lib/java/target

            - name: Download py build artifacts
              uses: actions/download-artifact@v2
              with:
                  name: build-uapi-py
                  path: lib/py/dist

            - name: Run tests
              run: |
                  cd qa/test
                  poetry install
                  poetry run poetry -m pytest
