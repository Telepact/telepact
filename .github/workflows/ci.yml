name: CI

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build-uapi-ts:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: "14"

            - name: Install dependencies
              run: |
                  cd lib/ts
                  npm install

            - name: Build ts
              run: |
                  cd lib/ts
                  npm run build

    build-uapi-java:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: "14"

            - name: Install dependencies and build
              run: |
                  cd lib/java
                  mvn install

    build-uapi-py:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: "14"

            - name: Install dependencies
              run: |
                  cd lib/py
                  poetry install

            - name: Build py
              run: |
                  cd lib/py
                  poetry build

    run-tests:
        runs-on: ubuntu-latest
        needs: [build-uapi-ts, build-uapi-java, build-uapi-py]
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Download ts build artifacts
              uses: actions/download-artifact@v2
              with:
                  name: build-uapi-ts
                  path: lib/ts/dist

            - name: Download java build artifacts
              uses: actions/download-artifact@v2
              with:
                  name: build-uapi-java
                  path: lib/java/target

            - name: Download py build artifacts
              uses: actions/download-artifact@v2
              with:
                  name: build-uapi-py
                  path: lib/py/dist

            - name: Run tests
              run: |
                  cd qa/test
                  poetry install
                  poetry run poetry -m pytest
